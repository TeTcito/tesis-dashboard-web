<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estad√≠stico de Atenci√≥n Lectora</title>
    <!-- Tailwind CSS para un dise√±o moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts para una mejor tipograf√≠a -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Clases personalizadas para los colores de estado */
        .status-atento { background-color: #28a745; color: white; }
        .status-sin-atencion-visual { background-color: #ffc107; color: #333; }
        .status-ojos-cerrados { background-color: #17a2b8; color: white; }
        .status-distraccion { background-color: #dc3545; color: white; }
        .status-iniciando { background-color: #6c757d; color: white; }
        /* Estilo para el bot√≥n de estudiante activo */
        .student-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Encabezado -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard de Atenci√≥n Lectora</h1>
            <!-- Selector de Estudiantes -->
            <div class="mt-4 flex items-center space-x-2 flex-wrap">
                <span class="text-gray-500 font-medium mr-2">Seleccionar Estudiante:</span>
                <button id="btn-est_01" onclick="changeStudent('est_01')" class="student-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 transition-all duration-200 mb-2">Estudiante 01</button>
                <button id="btn-est_02" onclick="changeStudent('est_02')" class="student-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 transition-all duration-200 mb-2">Estudiante 02</button>
                <!-- [NUEVO] Botones para Estudiantes 03 y 04 -->
                <button id="btn-est_03" onclick="changeStudent('est_03')" class="student-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 transition-all duration-200 mb-2">Estudiante 03</button>
                <button id="btn-est_04" onclick="changeStudent('est_04')" class="student-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 transition-all duration-200 mb-2">Estudiante 04</button>
            </div>
        </header>

        <!-- Contenedor principal del Dashboard (Grid) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna Izquierda: KPIs y Estado en Vivo -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Tarjeta de Estado en Tiempo Real -->
                <div id="statusCard" class="p-6 rounded-2xl shadow-lg transition-all duration-500 status-iniciando">
                    <h2 class="text-sm font-medium opacity-80 mb-2">ESTADO ACTUAL</h2>
                    <div class="flex items-center space-x-4">
                        <div id="statusIcon" class="text-5xl">‚è≥</div>
                        <div>
                            <div id="statusText" class="text-2xl font-bold">Iniciando...</div>
                            <div id="timestamp" class="text-xs opacity-80">Esperando datos...</div>
                        </div>
                    </div>
                </div>

                <!-- Tarjetas de Resumen (KPIs) -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow"><h3 class="text-sm text-gray-500">Alertas Totales</h3><p id="kpiAlerts" class="text-3xl font-bold text-red-500">0</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow"><h3 class="text-sm text-gray-500">% Tiempo en Foco</h3><p id="kpiFocusTime" class="text-3xl font-bold text-green-500">0%</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow col-span-2"><h3 class="text-sm text-gray-500">Duraci√≥n de Sesi√≥n</h3><p id="kpiSessionDuration" class="text-2xl font-bold text-gray-700">00:00</p></div>
                </div>
            </div>

            <!-- Columna Derecha: Gr√°ficos -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow"><h3 class="font-semibold mb-4">Resumen de la Sesi√≥n (Por Tiempo)</h3><div class="h-64 flex justify-center items-center"><canvas id="summaryChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-2xl shadow"><h3 class="font-semibold mb-4">L√≠nea de Tiempo de Atenci√≥n</h3><div class="h-64"><canvas id="timelineChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- SDK de Firebase (versi√≥n m√°s reciente) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBrBRs58PkQEvLnnKjT_FFrd52C7_vsN8M",
            authDomain: "atencion-lectora.firebaseapp.com",
            databaseURL: "https://atencion-lectora-default-rtdb.firebaseio.com",
            projectId: "atencion-lectora",
            storageBucket: "atencion-lectora.appspot.com",
            messagingSenderId: "151462633327",
            appId: "1:151462633327:web:8243c4eb272f3bbdf2d29a"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- L√≥gica para Dashboard Din√°mico ---
        let currentStudentId = '';
        let realtimeStatusRef, logsRef;

        const statusCard = document.getElementById('statusCard');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const timestampEl = document.getElementById('timestamp');
        const kpiAlerts = document.getElementById('kpiAlerts');
        const kpiFocusTime = document.getElementById('kpiFocusTime');
        const kpiSessionDuration = document.getElementById('kpiSessionDuration');
        const summaryCtx = document.getElementById('summaryChart').getContext('2d');
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        let summaryChart, timelineChart, chartUpdateTimeout;
        const CHART_UPDATE_INTERVAL = 2000;

        const statusConfig = {
            'ATENTO': { label: 'Atento', icon: '‚úÖ', color: '#28a745', class: 'status-atento' },
            'SIN ATENCION VISUAL': { label: 'Sin Atenci√≥n', icon: '‚ö†Ô∏è', color: '#ffc107', class: 'status-sin-atencion-visual' },
            'OJOS CERRADOS': { label: 'Ojos Cerrados', icon: 'üò¥', color: '#17a2b8', class: 'status-ojos-cerrados' },
            'DISTRACCION': { label: 'Distracci√≥n', icon: '‚ùå', color: '#dc3545', class: 'status-distraccion' },
            'Iniciando...': { label: 'Iniciando', icon: '‚è≥', color: '#6c757d', class: 'status-iniciando' }
        };

        function changeStudent(studentId) {
            if (currentStudentId === studentId) return;

            if (realtimeStatusRef) realtimeStatusRef.off();
            if (logsRef) logsRef.off();

            currentStudentId = studentId;
            
            realtimeStatusRef = database.ref(`analysis/${studentId}`);
            logsRef = database.ref(`analysis_logs/${studentId}`);

            document.querySelectorAll('.student-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${studentId}`).classList.add('active');
            
            resetDashboard();
            listenToData();
        }
        
        function listenToData() {
            realtimeStatusRef.on('value', (snapshot) => {
                const data = snapshot.val();
                updateRealtimeCard(data ? data.status : 'Iniciando...', data ? data.timestamp : new Date().toISOString());
            });

            logsRef.on('value', (snapshot) => {
                const logs = snapshot.val();
                if (logs) {
                    clearTimeout(chartUpdateTimeout);
                    chartUpdateTimeout = setTimeout(() => processLogsAndUpdateStats(logs), CHART_UPDATE_INTERVAL);
                } else {
                    resetDashboard();
                }
            });
        }

        function resetDashboard() {
            updateRealtimeCard('Iniciando...', new Date().toISOString());
            kpiAlerts.innerText = '0';
            kpiFocusTime.innerText = '0%';
            kpiSessionDuration.innerText = '00:00';
            if (summaryChart) summaryChart.destroy();
            if (timelineChart) timelineChart.destroy();
        }

        function updateRealtimeCard(status, timestamp) {
            const config = statusConfig[status] || statusConfig['Iniciando...'];
            statusCard.className = `p-6 rounded-2xl shadow-lg transition-all duration-500 ${config.class}`;
            statusIcon.innerText = config.icon;
            statusText.innerText = config.label;
            const date = new Date(timestamp);
            timestampEl.innerText = `Actualizado: ${date.toLocaleTimeString()}`;
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function processLogsAndUpdateStats(logs) {
            const logEntries = Object.values(logs).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (logEntries.length < 2) return;

            const totalDuration = (new Date().getTime() - new Date(logEntries[0].timestamp).getTime()) / 1000;
            if (totalDuration <= 0) return;

            const timeInState = { 'ATENTO': 0, 'SIN ATENCION VISUAL': 0, 'OJOS CERRADOS': 0, 'DISTRACCION': 0 };
            let alertCount = 0;

            for (let i = 0; i < logEntries.length - 1; i++) {
                const currentLog = logEntries[i];
                const nextLog = logEntries[i + 1];
                const duration = (new Date(nextLog.timestamp).getTime() - new Date(currentLog.timestamp).getTime()) / 1000;
                
                if (timeInState.hasOwnProperty(currentLog.status)) {
                    timeInState[currentLog.status] += duration;
                }

                if (currentLog.status !== 'ATENTO' && currentLog.status !== 'Iniciando...') {
                    alertCount++;
                }
            }

            kpiAlerts.innerText = alertCount;
            const focusPercentage = (timeInState['ATENTO'] / totalDuration) * 100;
            kpiFocusTime.innerText = `${Math.round(focusPercentage)}%`;
            kpiSessionDuration.innerText = formatDuration(totalDuration);

            updateSummaryChart(timeInState);
            updateTimelineChart(logEntries);
        }

        function updateSummaryChart(timeInState) {
            const data = {
                labels: Object.keys(timeInState).map(s => statusConfig[s] ? statusConfig[s].label : 'Otro'),
                datasets: [{ data: Object.values(timeInState), backgroundColor: Object.keys(timeInState).map(s => statusConfig[s] ? statusConfig[s].color : '#cccccc'), borderColor: '#ffffff', borderWidth: 4 }]
            };
            if (summaryChart) summaryChart.destroy();
            summaryChart = new Chart(summaryCtx, { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
        }

        function updateTimelineChart(logEntries) {
            const statusToNumeric = { 'ATENTO': 3, 'SIN ATENCION VISUAL': 2, 'OJOS CERRADOS': 1, 'DISTRACCION': 0 };
            const data = {
                labels: logEntries.map(log => new Date(log.timestamp).toLocaleTimeString()),
                datasets: [{
                    label: 'Nivel de Atenci√≥n', data: logEntries.map(log => statusToNumeric[log.status] ?? 0),
                    borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, stepped: true, tension: 0.1
                }]
            };
            if (timelineChart) timelineChart.destroy();
            timelineChart = new Chart(timelineCtx, {
                type: 'line', data: data,
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: function(value) { const label = Object.keys(statusToNumeric).find(key => statusToNumeric[key] === value); return statusConfig[label] ? statusConfig[label].label : ''; } }, min: 0, max: 3 } }, plugins: { legend: { display: false } } }
            });
        }
        
        // Iniciar con el primer estudiante por defecto al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            changeStudent('est_01');
        });
    </script>
</body>
</html>
